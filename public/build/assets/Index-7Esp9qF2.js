import{t as se,r,j as s,Q as te,S as a}from"./app-D2e3E3XV.js";import{A as oe,C as re,S as C,B as g,R as ne,D as le}from"./AdminSidebarLayout-COqDSJm5.js";import{s as ie}from"./index-BCmZvyIU.js";import{F as c}from"./index-D4xQY2I8.js";import{I as y}from"./index-BvjKgjyF.js";import{R as ae}from"./useIcons-Bk-sqBIx.js";import{F as ce}from"./Table-BwkSv8cC.js";import{E as $}from"./index-DD8aZ74l.js";import{M as k,R as de}from"./index-DsYq67bJ.js";import{S as z}from"./index-dQJIm9ox.js";import{R as A}from"./KeyOutlined-nSrCXqy4.js";import{T as me}from"./index-DlUzflYL.js";import{R as pe}from"./SafetyOutlined-BlJEqg7D.js";import{T as ue}from"./index-m_fbIKNS.js";import{B as D}from"./index-DN0Fc-0q.js";import{R as he}from"./MoreOutlined-DoUi7suo.js";import{R as xe}from"./EditOutlined-DJbavOcF.js";import"./SessionTimeout-CfqEmPbo.js";import"./Modal-J3vqZBmM.js";import"./transition-BB8nYaSI.js";import"./PrimaryButton-CAxNNQMa.js";import"./SecondaryButton-DEXX7yh7.js";import"./CheckCircleFilled-BiH3Zm4C.js";import"./InfoCircleFilled-bVzp4Yp4.js";import"./CSSMotionList-1BX_Nue5.js";import"./useForm-D6sLoAH1.js";import"./row-C-LMzcQh.js";import"./Input-xs5RiVsA.js";import"./getAllowClear-BoT9aE4f.js";import"./EyeOutlined-ByHKmIV0.js";import"./TextArea-Ba86vcsD.js";import"./DownOutlined-D3g4QtBj.js";import"./index-B8k0MQXY.js";const{Text:O}=me,{TextArea:fe}=y;function Ge({roles:p,allPermissions:B,filters:F}){const{token:v}=se.useToken(),[o,N]=ie.useMessage(),[U,d]=r.useState(!1),[u,h]=r.useState(null),[q,S]=r.useState(!1),[n,j]=r.useState(null),[I,x]=r.useState(""),[H,R]=r.useState(!1),[f,w]=r.useState(null),[L,T]=r.useState([]),[l]=c.useForm(),[m]=c.useForm(),[E,M]=r.useState(F.search||""),P=()=>{a.get("/admin-portal/roles",{search:E},{preserveState:!0,preserveScroll:!0})},Q=()=>{M(""),a.get("/admin-portal/roles",{},{preserveState:!0,preserveScroll:!0})},V=()=>{h(null),l.resetFields(),d(!0)},W=e=>{h(e),l.setFieldsValue({name:e.name,description:e.description}),d(!0)},Y=()=>{l.validateFields().then(e=>{u?a.put(`/admin-portal/roles/${u.id}`,e,{preserveScroll:!0,onSuccess:()=>{d(!1),h(null),l.resetFields(),o.success("Role updated successfully")},onError:t=>{const i=(t==null?void 0:t.message)||"Failed to update role";o.error(i)}}):a.post("/admin-portal/roles",e,{preserveScroll:!0,onSuccess:()=>{d(!1),l.resetFields(),o.success("Role created successfully")},onError:t=>{const i=(t==null?void 0:t.message)||"Failed to create role";o.error(i)}})})},Z=e=>{j(e),x(""),S(!0)},G=()=>{n&&a.delete(`/admin-portal/roles/${n.id}`,{onSuccess:()=>{S(!1),j(null),x(""),o.success("Role deleted successfully")},onError:e=>{const t=(e==null?void 0:e.message)||"Failed to delete role";o.error(t)}})},K=e=>{console.log("Fetching permissions for role:",e.id),window.axios.get(`/admin-portal/roles/${e.id}/permissions`).then(t=>{console.log("Response received:",t);const{role:i,permissions:_}=t.data;w(i),T(_),m.setFieldsValue({permissions:_}),R(!0)}).catch(t=>{console.error("Full error object:",t),console.error("Error response:",t.response),console.error("Error message:",t.message),o.error("Failed to load role permissions")})},J=()=>{m.validateFields().then(e=>{a.post(`/admin-portal/roles/${f.id}/sync-permissions`,e,{preserveScroll:!0,onSuccess:()=>{R(!1),w(null),m.resetFields(),o.success("Permissions updated successfully")},onError:t=>{const i=(t==null?void 0:t.message)||"Failed to update permissions";o.error(i)}})})},b=e=>["admin","secretary","member"].includes(e),X=e=>{const t=[{key:"permissions",label:"Manage Permissions",icon:s.jsx(A,{}),onClick:()=>K(e)}];return b(e.name)||(t.push({key:"edit",label:"Edit",icon:s.jsx(xe,{}),onClick:()=>W(e)}),t.push({key:"delete",label:"Delete",icon:s.jsx(de,{}),danger:!0,onClick:()=>Z(e)})),t},ee=[{title:"Role Name",dataIndex:"name",key:"name",width:180,render:e=>s.jsxs(C,{children:[s.jsx(pe,{style:{fontSize:"14px"}}),s.jsx(O,{strong:!0,style:{fontSize:"13px"},children:e}),b(e)&&s.jsx(ue,{color:"gold",style:{fontSize:"10px"},children:"SYSTEM"})]})},{title:"Description",dataIndex:"description",key:"description",ellipsis:!0,render:e=>s.jsx("span",{style:{fontSize:"13px"},children:e||"-"})},{title:"Users",dataIndex:"users_count",key:"users_count",width:100,align:"center",render:e=>s.jsx(D,{count:e,showZero:!0,style:{backgroundColor:v.colorPrimary},overflowCount:999})},{title:"Permissions",dataIndex:"permissions_count",key:"permissions_count",width:120,align:"center",render:e=>s.jsx(D,{count:e,showZero:!0,style:{backgroundColor:v.colorSuccess},overflowCount:999})},{title:"Actions",key:"actions",width:70,fixed:"right",render:(e,t)=>s.jsx(le,{menu:{items:X(t)},trigger:["click"],children:s.jsx(g,{type:"text",size:"small",icon:s.jsx(he,{})})})}];return s.jsxs(s.Fragment,{children:[s.jsx(te,{title:"Roles & Permissions - Tabata Welfare Association"}),s.jsxs(oe,{children:[N,s.jsxs(re,{children:[s.jsxs("div",{style:{marginBottom:16,display:"flex",justifyContent:"space-between",alignItems:"center",flexWrap:"wrap",gap:"12px"},children:[s.jsxs(C,{wrap:!0,children:[s.jsx(y,{placeholder:"Search roles...",prefix:s.jsx(ae,{}),value:E,onChange:e=>M(e.target.value),onPressEnter:P,style:{width:250},allowClear:!0}),s.jsx(g,{onClick:P,type:"primary",children:"Search"}),s.jsx(g,{onClick:Q,children:"Reset"})]}),s.jsx(g,{type:"primary",icon:s.jsx(ne,{}),onClick:V,children:"Add Role"})]}),s.jsx(ce,{columns:ee,dataSource:p.data,rowKey:"id",size:"small",pagination:{current:p.current_page,pageSize:p.per_page,total:p.total,showSizeChanger:!1,showTotal:e=>s.jsxs("span",{style:{fontSize:"13px"},children:["Total ",e," roles"]}),onChange:e=>{a.get("/admin-portal/roles",{...F,page:e},{preserveState:!0,preserveScroll:!0})}},locale:{emptyText:s.jsx($,{description:"No roles found",image:$.PRESENTED_IMAGE_SIMPLE})}})]}),s.jsx(k,{title:u?"Edit Role":"Add New Role",open:U,onCancel:()=>{d(!1),h(null),l.resetFields()},onOk:Y,okText:u?"Update":"Create",width:600,children:s.jsxs(c,{form:l,layout:"vertical",style:{marginTop:"24px"},children:[s.jsx(c.Item,{label:"Role Name",name:"name",rules:[{required:!0,message:"Please enter role name"},{pattern:/^[a-z_]+$/,message:"Use lowercase with underscores only (e.g., custom_role)"}],extra:"Use lowercase letters and underscores only (e.g., custom_role)",children:s.jsx(y,{placeholder:"e.g., custom_role"})}),s.jsx(c.Item,{label:"Description",name:"description",children:s.jsx(fe,{rows:3,placeholder:"Brief description of this role"})})]})}),s.jsxs(k,{title:"Delete Role",open:q,onCancel:()=>{S(!1),j(null),x("")},onOk:G,okText:"Delete",okButtonProps:{danger:!0,disabled:I!==(n==null?void 0:n.name)},children:[s.jsxs("p",{children:['Are you sure you want to delete role "',n==null?void 0:n.name,'"?']}),s.jsx("p",{children:"Type the role name to confirm:"}),s.jsx(y,{value:I,onChange:e=>x(e.target.value),placeholder:"Type role name here"})]}),s.jsx(k,{title:`Manage Permissions: ${(f==null?void 0:f.name)||""}`,open:H,onCancel:()=>{R(!1),w(null),m.resetFields()},onOk:J,okText:"Update Permissions",width:700,styles:{body:{maxHeight:"calc(100vh - 250px)",overflowY:"auto"}},children:s.jsx(c,{form:m,layout:"vertical",style:{marginTop:"24px"},children:s.jsx(c.Item,{label:`Select Permissions (${L.length} selected)`,name:"permissions",rules:[{required:!0,message:"Please select at least one permission"}],children:s.jsx(z,{mode:"multiple",placeholder:"Select permissions",style:{width:"100%"},onChange:T,optionFilterProp:"children",showSearch:!0,children:B.map(e=>s.jsx(z.Option,{value:e.id,children:s.jsxs(C,{children:[s.jsx(A,{style:{fontSize:"12px"}}),s.jsx("span",{children:e.name}),e.description&&s.jsxs(O,{type:"secondary",style:{fontSize:"11px"},children:["- ",e.description]})]})},e.id))})})})})]})]})}export{Ge as default};
